name: Build All Platforms

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Install Rust (macOS)
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: aarch64-apple-darwin,x86_64-apple-darwin
          
      - name: Install Tauri CLI
        run: npm install @tauri-apps/cli@1
        
      - name: Build for macOS
        run: npm run tauri build
        
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: src-tauri/target/release/bundle/

  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      # 关键：安装 MSVC 工具链，而不是默认的
      - name: Install Rust with MSVC
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          target: x86_64-pc-windows-msvc
          
      # 设置 MSVC 环境变量
      - name: Setup MSVC Environment
        uses: seanmiddleditch/gha-setup-vsdevenv@master
        
      # 清理可能的 MinGW 干扰
      - name: Clean environment
        run: |
          # 移除 MinGW 相关的环境变量
          echo "Cleaning environment..."
          
      # 安装 Tauri CLI
      - name: Install Tauri CLI
        run: npm install @tauri-apps/cli@1
        
      # 设置正确的链接器
      - name: Configure Rust for MSVC
        run: |
          # 确保使用 MSVC 链接器
          echo "Setting up MSVC linker..."
          # 这会在项目目录创建 cargo 配置
          mkdir -p .cargo
          echo '[target.x86_64-pc-windows-msvc]' >> .cargo/config.toml
          echo 'linker = "link.exe"' >> .cargo/config.toml
          
      # 构建应用
      - name: Build for Windows
        run: |
          # 设置 MSVC 链接器环境变量
          $env:RUSTFLAGS = "-C linker=link.exe"
          $env:CARGO_TARGET_X86_64_PC_WINDOWS_MSVC_LINKER = "link.exe"
          npm run tauri build
        env:
          RUSTFLAGS: "-C linker=link.exe"
          CARGO_TARGET_X86_64_PC_WINDOWS_MSVC_LINKER: "link.exe"
          
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-app
          path: src-tauri/target/release/bundle/